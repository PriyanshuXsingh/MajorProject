<%layout("/layouts/boilerplate")%>
<style>
      .dropdown-item img {
        width: 20px;
        margin-right: 10px;
      }
    </style>
<div class="row mt-4">
  <div class="col-8 offset-2">
<h3>Add a New Listing</h3>
<form method="post" action="/listings" class="needs-validation" novalidate enctype="multipart/form-data">
  <div class="mb-3">
    <label for="title" class="form-label">Title</label>
  <input name="listing[title]" placeholder="Enter your title" type="text" required class="form-control">
  <div class="valid-feedback">Title Looks Good!</div>
  </div>
  <div class="mb-3">
    <label for="desc" class="form-label">Description</label> 
    <textarea name="listing[description]" placeholder="Enter your description" required class="form-control"></textarea>
    <div class="invalid-feedback">Please enter a Short description</div>
  </div>
  
    <div class="mb-3 ">
      <label for="img-url" class="form-label">Upload Listing Image</label> 
      <input name="listing[image]" type="file"  class="form-control">
    </div>
    
  
  
  <div class="row">
    <div class="mb-3 col-7">
      <label for="price" class="form-label">Price</label>
      <input name="listing[price]" placeholder="Enter your price" type="number" required class="form-control">
      <div class="invalid-feedback">Price Should be Valid!</div>
    </div>
 
   <div class="mb-3 col-md-5">
     <label for="country" class="form-label">Country</label>
        <div class="dropdown">
          <button
            class="btn btn-light dropdown-toggle w-100"type="button"id="countryDropdownBtn"
            data-bs-toggle="dropdown"aria-expanded="false"
          >
            --Select Country--
          </button>
          <ul class="dropdown-menu w-100" id="countryDropdown"></ul>
        </div>
        <input
          type="hidden"
          name="listing[country]"
          id="selectedCountry"
          required
        />
        <div class="invalid-feedback">Please select a valid country!</div>
    </div>
  </div>
  
  <div class="mb-3">
    <label for="location" class="form-label">Location</label>
   <input name="listing[location]" placeholder="Enter your location" type="text" required class="form-control">
   <div class="invalid-feedback">location Should be Valid!</div>
  </div>

  <button class="btn btn-dark add-btn">Add</button><br><br>
</form>
</div>
</div>

const countryDropdown = document.getElementById("countryDropdown");
const countryDropdownBtn = document.getElementById("countryDropdownBtn");
const selectedCountryInput = document.getElementById("selectedCountry");

fetch("https://restcountries.com/v3.1/all")
  .then(response => response.json())
  .then(data => {
    console.log("Fetched data:", data); // Debugging: Check API response

    const countries = data
      .filter(country => country.name && country.name.common) // Remove missing names
      .map(country => ({
        name: country.name.common,
        flag: country.flags ? country.flags.png : '' // Handle missing flags
      }))
      .sort((a, b) => a.name.localeCompare(b.name));

    if (countries.length === 0) {
      console.error("No valid countries found!");
      return;
    }

    // Populate dropdown
    countries.forEach(country => {
      const listItem = document.createElement("li");
      listItem.innerHTML = `
        <a class="dropdown-item d-flex align-items-center" href="#" data-country="${country.name}">
          ${country.flag ? `<img src="${country.flag}" alt="${country.name}" width="20" class="me-2">` : ''} 
          ${country.name}
        </a>
      `;
      countryDropdown.appendChild(listItem);

      // Click event to update selection
      listItem.querySelector("a").addEventListener("click", function (e) {
        e.preventDefault();
        countryDropdownBtn.innerHTML = `${country.flag ? `<img src="${country.flag}" width="20" class="me-2">` : ''} ${country.name}`;
        selectedCountryInput.value = country.name;
      });
    });

    console.log("Dropdown populated successfully!"); // Debugging
  })
  .catch(error => console.error("Error fetching countries:", error));

